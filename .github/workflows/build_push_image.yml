# Nama tindakan: Build and Push Docker Image
name: Build and Push Docker Image

# Tindakan ini akan dijalankan ketika ada push ke repositori pada cabang tertentu.
on:
  push:
    branches:
      - karsajobs-github-package

# Job yang akan dijalankan pada runner Ubuntu terbaru. Anda dapat mengganti runner sesuai kebutuhan.
jobs:
  # Job bernama 'build'
  build:
    # Menjalankan job pada sistem operasi Ubuntu terbaru.
    runs-on: ubuntu-latest

    # Langkah-langkah yang akan dijalankan dalam job ini.
    steps:
      # Langkah pertama: Checkout kode dari repositori.
      - name: Checkout code
        uses: actions/checkout@v2

      # Langkah kedua: lint Dockerfile menggunakan hadolint.
      - name: lint-dockerfile
        run: |
          # Install hadolint
          sudo wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          sudo chmod +x /bin/hadolint

          # Run hadolint
          hadolint Dockerfile
        working-directory: ${{ github.workspace }}

      # Langkah ketiga: Menjalankan unit test untuk backend.
      - name: test-app
        run: go test -v -short --count=1 $(go list ./...)
        working-directory: ${{ github.workspace }}

      # Langkah keempat: Log in to GitHub Packages menggunakan GitHub Token.
      - name: Log in to GitHub Packages
        run: echo "${{ secrets.GHCR_GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_GITHUB_USERNAME }} --password-stdin

      # Langkah kelima: Build Docker Image.
      - name: Build Docker Image
        run: |
          # Menjalankan perintah untuk membangun Docker image dengan tag sesuai dengan repository dan branch.
          docker build -t ghcr.io/${{ secrets.GHCR_GITHUB_USERNAME }}/karsajobs:latest .
        working-directory: ${{ github.workspace }}

      # Langkah keenam: Push Docker Image ke GitHub Packages.
      - name: Push Docker Image to GitHub Packages
        run: |
          # Melakukan push Docker image ke GitHub Packages dengan tag sesuai dengan repository dan branch.
          docker push ghcr.io/${{ secrets.GHCR_GITHUB_USERNAME }}/karsajobs:latest
